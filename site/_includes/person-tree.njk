{% macro photoImg(photo, initials, cssClass, altText) %}
  {% if photo and photo.url %}
    {% if photo.remote %}
      <img class="{{ cssClass }}" src="{{ photo.url }}" alt="{{ altText }}" loading="lazy">
    {% else %}
      <img class="{{ cssClass }}" src="{{ photo.url | url }}" alt="{{ altText }}" loading="lazy">
    {% endif %}
  {% else %}
    {{ initials }}
  {% endif %}
{% endmacro %}

{% macro renderPerson(person, depth) %}
<li class="person{% if person.children.length %} has-children{% else %} leaf{% endif %}" data-depth="{{ depth }}">
  <div class="person-row">
    <div class="person-row__content">
      <div class="person-avatar">{{ photoImg(person.photo, person.initials, 'person-photo', person.fullName ~ ' portrait') }}</div>
      {% if person.children.length %}
        <span class="toggle-icon">▾</span>
      {% else %}
        <span class="toggle-icon leaf-icon">•</span>
      {% endif %}
      <span class="person-name">{{ person.fullName }}</span>

      {% for spouse in person.spouses %}
        <span
          class="spouse-badge{% if spouse.deceased %} deceased{% endif %}{% if spouse.external %} external{% endif %}"
          data-photo-src="{% if spouse.photo and spouse.photo.url %}{% if spouse.photo.remote %}{{ spouse.photo.url }}{% else %}{{ spouse.photo.url | url }}{% endif %}{% endif %}"
          data-initials="{{ spouse.initials }}"
        >
          ⚭ <span class="spouse-name">{{ spouse.fullName }}</span>
          {% if spouse.external and spouse.externalUrl %}
            <a href="{{ spouse.externalUrl }}" class="ext-link" title="Open spouse external link" target="_blank" rel="noopener noreferrer">↗</a>
          {% endif %}
          <button class="spouse-details-btn" type="button" title="View spouse details" aria-label="View details for {{ spouse.fullName }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </span>
      {% endfor %}
    </div>

    <button class="details-btn" type="button" title="View details" aria-label="View details for {{ person.fullName }}">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    </button>
  </div>

  {% if person.children.length %}
    <ul class="children{% if depth >= 2 %} collapsed{% endif %}">
      {% for child in person.children %}
        {{ renderPerson(child, depth + 1) }}
      {% endfor %}
    </ul>
  {% endif %}
</li>
{% endmacro %}
